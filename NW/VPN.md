널널한 개발자 VPN 강의


배경: 코로나 등 이슈로 외부(Untrusted Network)에서 내부(Trusted Network)로의 안전한 접속이 필요해짐.

핵심: 물리적망을 새로 깔 수 없으니, 공용망 위에 **가상의 터널(VPN)**을 뚫음. 이때 설명하는 내용은 **Layer 3 터널링** 방식의 ipsec 방식이다. 

동작 (Client):

- 앱이 회사 서버 IP(3.3.3.10)로 요청.

- OS 라우팅 테이블이 이를 보고 가상 NIC로 패킷을 던짐.

- VPN 클라이언트가 **원본 패킷 전체**(헤더+바디)를 암호화하고, 앞에 공인 IP 헤더를 붙임 **(캡슐화)**.

- 전송: 인터넷을 통해 회사 SG(VPN Gateway)로 전달.

- 동작 (Server): SG가 겉 포장을 뜯고(복호화), 속에 있던 원본 패킷을 꺼내 내부 서버로 전달.

<details>
  <summary> 처음에 했던 정리</summary>
  

VPN은 말그대로 가상의 private network, 가상의 LAN입니다. 


VPN은 종류가 그리고 프로토콜이 여러가지이지만, 나는 layer3 기준의 vpn 그 중에서도 ipsec vpn을 사용한다고 가정하고 말하겠습니다

원래는 회사의 LAN이 있어서, GW를 지나지 않고 통신이 가능했음. 보안 정책도 GW 기준 외부만 막으면 됐었고, 접근 정책 같은 내부 정책들은 그에 맞게 설계하면 됐었음. 회사의 Gateway기준이었기 때문에, 출장을 나가거나, 외부에서 접속하는 것은 불가능했었음. 

하지만 코로나로 인해서 모두가 외부에서 회사 서버로 접근을 해야 하는 상황이 발생했다. 그래서 선택지는 보안 정책을 그에 맞게 외부, 내부를 다 개편하는 the hard way와, 외부에 있는 사람에게 내부에 있는 것처럼 동작할 수 있도록 하게 하거나. 

이를 위해서는 VPN, 그리고 이를 가능하게 해주는 라우터의 기능 Secure Gateway(SG)가 등장하게 된다. 

원래 회사의 IP 대역이 3.3.3.X였다면, 외부에 있는 컴퓨터에 VPN software를 설치해서, 컴퓨터의 커널 영역에 가상의 NIC 디바이스와 이가 동작할 수 있는 가상의 IP, TCP 계층이 생긴다고 가정한다. 그리고 사용자 영역에서 회사의 서버, 즉 3.3.3.10으로 접속을 하고자 하면, 
ㅏ용자의 가상의 IP, TCP 영역으로 보내지게 되고, 가상의NIC에서 이에 맞는 헤더가 붙게 된다. 그리고 나서 원래 ISP에서 제공하는 ip주소가 헤더로 붙게 되고, 이떄의 바디는 암호화된다. 그러면 사용자의 원래 있던 router로부터 src는 본인 원래 ISP의 IP, 그리고 dst는 회사의 라우터로 보내지게 된다.

회사의 라우터의 SG는 해당 패킷을 받으면, src ip가 아 터널링 대상임을 알고, 거기서부터 바디를 복호화하고, 원래 dst이었던 회사의 서버로 보내지게 된다. 

즉, VPN은 SG로 인해서 가능하게 된 것이고,ip 측에서 헤더를 중복을 붙이면서 가능하게 된 것이다. 
</details>
